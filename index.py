#!/usr/bin/env python
# index for the documentation
from glob import glob
from collections import defaultdict

LANG = {
    "en": "English",
    "hu": "Hungarian",
    "pt": "Portuguese",
    "de": "German",
    "ru": "Russian",
    "fr": "French",
    "it": "Italian",
    "ca": "Catalan",
    "tr": "Turkish"
}

intro = """\
<!DOCTYPE html>
<head>
<link rel="stylesheet" href="/html/en/website/_static/sage.css" type="text/css" />
<style>
html {margin: 20px; }
body { background-color: white; }
</style>
<link rel="shortcut icon" href="/html/en/website/_static/favicon.ico"/>
</head>
<body>
<a href="http://www.sagemath.org/">
<img width="350" alt="SageMath Logo"
style="border-radius: 10px;"
src="http://www.sagemath.org/pix/sage_logo_new_l_hc_edgy-nq8.png"
title="SageMath Mathematical Software">
</a>
"""

filter_ref = ["graph-", "generic-graph-"]
filter_html = [("en","website")]

pages = {"html": defaultdict(list), "pdf": defaultdict(list)}

for path in glob("*/*"):
    what, lang = path.split("/")

    for path2 in glob(path + "/*"):
        if what == "html":
            EXT = "/index.html"
            for fn in glob(path2 + EXT):
                pages[what][lang].append(fn)
        elif what == "pdf":
            for EXT in ["/*.pdf", "/*/*.pdf"]:
                for fn in glob(path2 + EXT):
                    pages[what][lang].append(fn)


output = [intro]
output.append("<h1>Documentation</h1>")

for what in sorted(pages.keys()):
    output.append("<h2>%s</h2>" % what.upper())
    output.append("<ul>")
    for lang, entries in sorted(pages[what].iteritems()):
        output.append("<li><a href='%s/%s'>%s</a></li>" % (what, lang, LANG.get(lang, lang)))
        output.append("<ul>")
        for entry in sorted(entries):
            entries = entry.split("/")
            if what == "html":
                if tuple(entries[-3:-1]) in filter_html:
                    continue
                fn = entries[-2].replace("_", " ").title()
                subcat = ""
            elif what == "pdf":
                if any(entries[-1].startswith(_) for _ in filter_ref):
                    continue
                fn = entries[-1][:-4] \
                    .replace("_", " ") \
                    .title() + " (pdf)"
                subcat = (entries[2].title() + ": ") if len(
                    entries) >= 5 else ""
            output.append("<li><a href='{path}'>{subcat}{fn}</a></li>".format(
                          path=entry,
                          lang=LANG.get(lang, lang),
                          subcat=subcat,
                          fn=fn))
        output.append("</ul>")
    output.append("</ul>")
    output.append("</body></html>")

with open("index.html", "w") as index:
    index.write("\n".join(output))

# create minimal index.html files in subdirectories
IDX_TOKEN = "<!-- generated by index.py -->"  # to recognize it later on!
from os import walk, sep
from os.path import join
for root, path, filenames in walk("html" + sep):
    # ignore files in _static, ...
    if any(_.startswith("_") for _ in root.split(sep)):
        continue
    # if there is no index.html file
    idxfn = join(root, "index.html")
    if "index.html" not in filenames or IDX_TOKEN in open(idxfn, "r").read():
        # now we have to write our index.html file
        print idxfn
        index = [intro]
        index.append(IDX_TOKEN)
        index.append('<p><a href="../index.html">Parent Directory</a></p>')
        path = filter(lambda _: not _.startswith("_"), path)
        if len(path) > 0:
            index.append('<h2>Sub-Directories</h2>')
            for p in sorted(path):
                index.append('<p><a href="%(p)s/">%(p)s</a></p>' % {"p": p})
        filenames = filter(lambda fn : not(fn == "index.html" or fn.startswith("genindex-") or fn.startswith(".")),
                           filenames)
        if len(filenames) > 0:
            index.append('<h2>Pages</h2>')
            for fn in sorted(filenames):
                index.append('<p><a href="%(fn)s">%(fn)s</a></p>' % {"fn": fn})
        # print "    ", path, filenames
        index.append("</body></html>")
        with open(idxfn, "w") as outidx:
             outidx.write("\n".join(index))


import sys
if len(sys.argv) > 1 and sys.argv[1] == "fix":
            # fixes the static links in sphinx
            # !!! ONLY RUN THIS ONCE !!!

    import os
    import subprocess as sp
    os.chdir(os.path.expanduser("~/documentation/html/"))
    ROOT = os.path.abspath(os.curdir)

    for link in sp.Popen("find -type l -name _static".split(), stdout=sp.PIPE).stdout:
        d = os.path.normpath(os.path.join(ROOT, link.rsplit("/", 1)[0]))
        print d
        os.chdir(d)
        os.system(
            r'find -type f -name "*.html" -exec sed -i "s/_static/..\/_static/" {} \;')
